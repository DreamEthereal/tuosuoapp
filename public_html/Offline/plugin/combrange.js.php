<?php
//dezend by http://www.yunlu99.com/
echo 'function create_combrange_qtn(questionID)' . "\r\n" . '{' . "\r\n" . '	var theInfoQtnName = qNoScriptString(QtnListArray[questionID].questionName);' . "\r\n" . '' . "\r\n" . '	//显示题目' . "\r\n" . '	var check_survey_form_no_con_list = \'\';' . "\r\n" . '	var questionRequire = \'\';' . "\r\n" . '	var questionName = \'\';' . "\r\n" . '	var questionNotes = \'\';' . "\r\n" . '	if( QtnListArray[questionID].isRequired == 1 )' . "\r\n" . '	{' . "\r\n" . '		questionRequire = \'<span class=red>*</span>\';' . "\r\n" . '	}' . "\r\n" . '	questionName = qQuotaChar(qJsonCharFilter(QtnListArray[questionID].questionName));' . "\r\n" . '	questionNotes = \'[复合矩阵单选题]\';' . "\r\n" . '' . "\r\n" . '	var dataqtn = "{ ";' . "\r\n" . '	dataqtn += " questionID: "+questionID+",";' . "\r\n" . '	dataqtn += " questionRequire: \'"+questionRequire+"\',";' . "\r\n" . '    dataqtn += " questionName: \'"+qShowQtnName(questionName,questionID,1)+"\',";' . "\r\n" . '	dataqtn += " questionNotes: \'"+questionNotes+"\',";' . "\r\n" . '    questionTips = qQuotaChar(qJsonCharFilter(QtnListArray[questionID].questionNotes));' . "\r\n" . '    dataqtn += " questionTips: \'"+qShowQtnName(questionTips,questionID,2)+"\',";' . "\r\n" . '' . "\r\n" . '	var Label = [];' . "\r\n" . '	dataqtn += " answers:[";' . "\r\n" . '	for( var question_range_labelID in LabelListArray[questionID] )' . "\r\n" . '	{' . "\r\n" . '		var theLabelArray = LabelListArray[questionID][question_range_labelID];' . "\r\n" . '' . "\r\n" . '		dataqtn += "{";' . "\r\n" . '		dataqtn += " optionLabelName:\'"+qJsonCharFilter(theLabelArray.optionLabel)+"\',";' . "\r\n" . '		dataqtn += " optionLabelID:\'"+question_range_labelID+"\'";' . "\r\n" . '		Label[question_range_labelID] = theLabelArray.optionLabel;' . "\r\n" . '		dataqtn += "},";' . "\r\n" . '	}' . "\r\n" . '	dataqtn = dataqtn.substr(0,dataqtn.length-1)+"],";' . "\r\n" . '' . "\r\n" . '	var theRadioListArray = [];' . "\r\n" . '	var optionTotalNum = count(OptionListArray[questionID]);' . "\r\n" . '	if( QtnListArray[questionID].isRandOptions == 1 ) //随机' . "\r\n" . '	{' . "\r\n" . '		 var tmpArray = [];' . "\r\n" . '		 for(var tmp in OptionListArray[questionID] )' . "\r\n" . '		 {' . "\r\n" . '			 tmpArray.push(tmp);' . "\r\n" . '		 }' . "\r\n" . '		 var theRandListArray = array_rand(tmpArray,optionTotalNum);' . "\r\n" . '		 for( var i=0;i<theRandListArray.length;i++)' . "\r\n" . '		 {' . "\r\n" . '			 theRadioListArray.push(tmpArray[theRandListArray[i]]);' . "\r\n" . '		 }' . "\r\n" . '		 tmpArray = null;' . "\r\n" . '		 theRandListArray = null;' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		 for( var tmp in OptionListArray[questionID] )' . "\r\n" . '		 {' . "\r\n" . '			theRadioListArray.push(tmp);' . "\r\n" . '		 }' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	var remove_value_list = \'\';' . "\r\n" . '	dataqtn += " qtns:[ ";' . "\r\n" . '	for( var k in theRadioListArray )' . "\r\n" . '	{' . "\r\n" . '		var question_range_optionID = theRadioListArray[k];' . "\r\n" . '		var theQuestionArray = OptionListArray[questionID][question_range_optionID];' . "\r\n" . '' . "\r\n" . '		dataqtn += "{";' . "\r\n" . '		dataqtn += "optionName:\'"+qJsonCharFilter(theQuestionArray.optionName)+"\',";' . "\r\n" . '		dataqtn += "optionNameID:\'"+question_range_optionID+"\',";' . "\r\n" . '' . "\r\n" . '		//矩阵行关联' . "\r\n" . '		var QtnAssCon = _GetQtnAssCond(questionID,question_range_optionID);' . "\r\n" . '		var remove_value_list_qtn = \'\';' . "\r\n" . '' . "\r\n" . '		var sub_option_list = \'\';' . "\r\n" . '		for( var question_range_labelID in Label )' . "\r\n" . '		{' . "\r\n" . '			var optionLabel = Label[question_range_labelID];' . "\r\n" . '			var theOptionID = \'option_\'+questionID+\'_\'+question_range_optionID+\'_\'+question_range_labelID;' . "\r\n" . '' . "\r\n" . '			var optionList = \'\';' . "\r\n" . '			for( var question_range_answerID in AnswerListArray[questionID] )' . "\r\n" . '			{' . "\r\n" . '				var theAnswerArray = AnswerListArray[questionID][question_range_answerID];' . "\r\n" . '				var optionAnswer = qJsonCharFilter(theAnswerArray.optionAnswer);' . "\r\n" . '				optionList += "<option value=\\""+question_range_answerID+"\\" ";' . "\r\n" . '				if( count(dataRow.rows) != 0 )' . "\r\n" . '				{' . "\r\n" . '					if( dataRow.rows[0][dataIndex[theOptionID]] != \'\' && dataRow.rows[0][dataIndex[theOptionID]] != \'0\' && dataRow.rows[0][dataIndex[theOptionID]] == question_range_answerID.toString() )' . "\r\n" . '					{' . "\r\n" . '						optionList += "selected";' . "\r\n" . '					}' . "\r\n" . '					else' . "\r\n" . '					{' . "\r\n" . '						optionList += ""; ' . "\r\n" . '					}			' . "\r\n" . '				}' . "\r\n" . '				else' . "\r\n" . '				{' . "\r\n" . '					optionList += "";' . "\r\n" . '				}' . "\r\n" . '				optionList += ">"+optionAnswer+"</option>";' . "\r\n" . '			}' . "\r\n" . '			sub_option_list += \'<td class="answer" align="center" valign=center><select name="\'+theOptionID+\'" id="\'+theOptionID+\'"><option value="">请选择...</option>\'+optionList+\'</select></td><td width=10></td>\';' . "\r\n" . '' . "\r\n" . '			//处理页面字段' . "\r\n" . '			this_fields_list += theOptionID+\'|\';' . "\r\n" . '			this_fields_type += \'5|\';' . "\r\n" . '			//页面检查' . "\r\n" . '			if( QtnAssCon != \'\' )' . "\r\n" . '			{' . "\r\n" . '				check_survey_form_no_con_list += "\\tif("+QtnAssCon+")\\n\\t{\\n";' . "\r\n" . '				check_survey_form_no_con_list += "\\t\\tListUnSelect(document.Survey_Form."+theOptionID+");\\n";' . "\r\n" . '				check_survey_form_no_con_list += "\\t} \\n";' . "\r\n" . '				check_survey_form_no_con_list += "\\telse { \\n";' . "\r\n" . '				check_survey_form_no_con_list += "\\t\\tif (!CheckListNoSelect(document.Survey_Form."+theOptionID+", \'"+theInfoQtnName+\' - \'+qNoScriptString(theQuestionArray.optionName)+\' - \'+qNoScriptString(optionLabel)+"\')){return false;}\\n\\t} \\n";' . "\r\n" . '			}' . "\r\n" . '			else' . "\r\n" . '			{' . "\r\n" . '				if( QtnListArray[questionID].isRequired == 1 )' . "\r\n" . '				{' . "\r\n" . '					check_survey_form_no_con_list += "\\tif (!CheckListNoSelect(document.Survey_Form."+theOptionID+", \'"+theInfoQtnName+\' - \'+qNoScriptString(theQuestionArray.optionName)+\' - \'+qNoScriptString(optionLabel)+"\')){return false;} \\n";' . "\r\n" . '				}' . "\r\n" . '			}' . "\r\n" . '			//记录移除值' . "\r\n" . '			remove_value_list +="\\tListUnSelect(document.Survey_Form."+theOptionID+");\\n";' . "\r\n" . '			if( QtnAssCon != \'\' )' . "\r\n" . '			{' . "\r\n" . '				remove_value_list_qtn +="\\t\\tListUnSelect(document.Survey_Form."+theOptionID+");\\n";' . "\r\n" . '			}' . "\r\n" . '		}' . "\r\n" . '		dataqtn += "sub_option_list:\'"+sub_option_list+"\' ";' . "\r\n" . '		dataqtn += "},";' . "\r\n" . '' . "\r\n" . '		//矩阵行关联' . "\r\n" . '		if( QtnAssCon != \'\' )' . "\r\n" . '		{' . "\r\n" . '			check_survey_conditions_list += "\\tif("+QtnAssCon+")\\n\\t{\\n";' . "\r\n" . '			check_survey_conditions_list += "\\t\\t$(\\"#range_combrange_"+question_range_optionID+"_container\\").hide();\\n";			' . "\r\n" . '			check_survey_conditions_list += remove_value_list_qtn;' . "\r\n" . '			check_survey_conditions_list += "\\t} \\n";' . "\r\n" . '			check_survey_conditions_list += "\\telse { \\n";' . "\r\n" . '			check_survey_conditions_list += "\\t\\t$(\\"#range_combrange_"+question_range_optionID+"_container\\").show();\\n\\t} \\n";' . "\r\n" . '		}' . "\r\n" . '	}' . "\r\n" . '	dataqtn = dataqtn.substr(0,dataqtn.length-1)+"] }";' . "\r\n" . '' . "\r\n" . '	//逻辑条件' . "\r\n" . '	var QuestionCon = _GetQuestionCond(questionID,qid);' . "\r\n" . '	if( QuestionCon != \'\' )' . "\r\n" . '	{' . "\r\n" . '		check_survey_conditions_list += "\\tif("+QuestionCon+")\\n\\t{\\n";' . "\r\n" . '		check_survey_conditions_list += "\\t\\t$(\'#question_"+questionID+"\').show();\\n\\t} \\n";' . "\r\n" . '		check_survey_conditions_list += "\\telse { \\n";' . "\r\n" . '		check_survey_conditions_list += "\\t\\t$(\'#question_"+questionID+"\').hide();\\n\\t} \\n";' . "\r\n" . '' . "\r\n" . '		var check_form_list = "\\tif("+QuestionCon+")\\n\\t{\\n";' . "\r\n" . '		check_form_list += check_survey_form_no_con_list;' . "\r\n" . '		check_form_list += "\\t}\\n";' . "\r\n" . '		//移除已回复的值' . "\r\n" . '		check_form_list += "\\telse{\\n";' . "\r\n" . '		check_form_list += remove_value_list;' . "\r\n" . '		check_form_list += "\\t}\\n";' . "\r\n" . '		' . "\r\n" . '		check_survey_form_list += check_form_list;' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		check_survey_form_list += check_survey_form_no_con_list;' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	//改变背景颜色' . "\r\n" . '	check_survey_conditions_list += "\\tchangeMaskingQtnBgColor("+questionID+");\\n";' . "\r\n" . '' . "\r\n" . '	var tplText = \'<table width="100%" class="pertable" id="question_{$questionID}"><tr><td class="question" valign=center>&nbsp;{$questionRequire}<span class="textEdit" id="questionName_{$questionID}">{$questionName}</span>&nbsp;<span class=notes>{$questionNotes}</span></td></tr><tr><td class="tips"><span class="textEdit" id="questionNotes_{$questionID}">{$questionTips}</span></td></tr><tr><td><table cellSpacing=0 cellPadding=0 id="qtn_table_{$questionID}"><tr class=tdheight><td>&nbsp;</td><td width=8></td>{foreach $answers as $j => $answer}<td class="answer" align="center" valign=center nowrap><span class="textEdit" id="optionLabel_26_{$questionID}_{$answer.optionLabelID}">{$answer.optionLabelName}</span></td><td width=10></td>{/foreach}</tr>{foreach $qtns as $i => $qtn}<tr class=tdheight id="range_combrange_{$qtn.optionNameID}_container"><td class="answer" nowrap valign=center>&nbsp;&nbsp;<span class="textEdit" id="optionName_26_{$questionID}_{$qtn.optionNameID}">{$qtn.optionName}</span></td><td width=8></td>{$qtn.sub_option_list}</tr>{/foreach}</table></td></tr></table>\';' . "\r\n" . '' . "\r\n" . '	//关联关系' . "\r\n" . '	var RelSurveyCon = _GetSurveyValueRelationCond(questionID,qid,\'cn\');' . "\r\n" . '	if( RelSurveyCon != \'\' )' . "\r\n" . '	{' . "\r\n" . '		//此题存在多个数值关联关系的检查点' . "\r\n" . '		var theRelSurveyCon = RelSurveyCon.split(\'$$$$$$\');' . "\r\n" . '		for( var t in theRelSurveyCon )' . "\r\n" . '		{' . "\r\n" . '			var tRelSurveyCon = theRelSurveyCon[t].split(\'######\');' . "\r\n" . '			if( parseInt(tRelSurveyCon[0]) == 2 ) //空题' . "\r\n" . '			{' . "\r\n" . '				survey_empty_list += tRelSurveyCon[1];' . "\r\n" . '				var theEmptyList = tRelSurveyCon[1].split(\'*\');' . "\r\n" . '				var theEmptyId = parseInt(substr(theEmptyList[7],0,-3));' . "\r\n" . '				if( !IsSamePage(theEmptyId,questionID)) //不在同页' . "\r\n" . '				{' . "\r\n" . '					//空题字段' . "\r\n" . '					this_fields_list += \'option_\'+theEmptyId+\'|\';' . "\r\n" . '					this_fields_type += \'3|\';' . "\r\n" . '					//跑一遍空题的配额表达式' . "\r\n" . '					var theEmptyEndSurveyCon = _GetSurveyQuotaCond(theEmptyId,qid,\'cn\');' . "\r\n" . '					if( theEmptyEndSurveyCon != \'\' )' . "\r\n" . '					{' . "\r\n" . '						survey_quota_list += theEmptyEndSurveyCon;' . "\r\n" . '					}' . "\r\n" . '				}' . "\r\n" . '				theEmptyList = null;' . "\r\n" . '			}' . "\r\n" . '			else' . "\r\n" . '			{' . "\r\n" . '				survey_quota_list += tRelSurveyCon[1];' . "\r\n" . '			}' . "\r\n" . '			tRelSurveyCon = null;' . "\r\n" . '		}' . "\r\n" . '		theRelSurveyCon = null;' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '    var jsondata = eval(\'(\'+dataqtn+\')\');' . "\r\n" . '	var t = new jSmart(tplText);' . "\r\n" . '	//$(\'#survey_content_container\').append( t.fetch(jsondata)); ' . "\r\n" . '	survey_content_container_html += t.fetch(jsondata);' . "\r\n" . '	jsondata = null;' . "\r\n" . '	theQuestionArray = null;' . "\r\n" . '	theRadioListArray = null;' . "\r\n" . '	theLabelArray = null;' . "\r\n" . '	Label = null;' . "\r\n" . '}';

?>
