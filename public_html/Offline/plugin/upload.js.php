<?php
//dezend by http://www.yunlu99.com/
echo 'function create_upload_qtn(questionID)' . "\r\n" . '{' . "\r\n" . '	var theInfoQtnName = qNoScriptString(QtnListArray[questionID].questionName);' . "\r\n" . '' . "\r\n" . '	var questionNotes = \'[上传题]\';' . "\r\n" . '	var questionRequire = \'\';' . "\r\n" . '	var questionName = \'\';' . "\r\n" . '	if( QtnListArray[questionID].isRequired == 1 )' . "\r\n" . '	{' . "\r\n" . '		questionRequire = \'<span class=red>*</span>\';' . "\r\n" . '	}' . "\r\n" . '	questionName = qQuotaChar(qJsonCharFilter(QtnListArray[questionID].questionName));' . "\r\n" . '' . "\r\n" . '	var jsonqtn = "";' . "\r\n" . '	jsonqtn += "{";' . "\r\n" . '    jsonqtn += " questionName: \'"+qShowQtnName(questionName,questionID,1)+"\',";' . "\r\n" . '	jsonqtn += " questionRequire:\'"+questionRequire+"\',";' . "\r\n" . '	jsonqtn += " questionID:"+questionID+",";' . "\r\n" . '	jsonqtn += " questionNotes:\'"+questionNotes+"\',";' . "\r\n" . '    questionTips = qQuotaChar(qJsonCharFilter(QtnListArray[questionID].questionNotes));' . "\r\n" . '	jsonqtn += " questionTips:\'"+qShowQtnName(questionTips,questionID,2)+"\',";' . "\r\n" . '	jsonqtn += " optionID:\'option_"+questionID+"\',";' . "\r\n" . '	if( count(dataRow.rows) != 0 )' . "\r\n" . '	{' . "\r\n" . '		jsonqtn += " value:\'"+dataRow.rows[0][dataIndex[\'option_\'+questionID]]+"\',";' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		jsonqtn += " value:\'\',";' . "\r\n" . '	}' . "\r\n" . '	jsonqtn += " length:\'"+QtnListArray[questionID][\'length\']+"\',";' . "\r\n" . '	if( parseInt(surveyRow.rows[0][4] ) == 1 )' . "\r\n" . '	{' . "\r\n" . '		jsonqtn += " hiddenVarName_1:\'\',";' . "\r\n" . '		jsonqtn += " hiddenVarName_2:\'none\',";' . "\r\n" . '		jsonqtn += " hiddenVarName_3:\'none\',";' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		var theHiddenVarName = QtnListArray[questionID].hiddenVarName.split(\',\');' . "\r\n" . '		if( in_array(1,theHiddenVarName) )' . "\r\n" . '		{' . "\r\n" . '			jsonqtn += " hiddenVarName_1:\'\',";' . "\r\n" . '		}' . "\r\n" . '		else' . "\r\n" . '		{' . "\r\n" . '			jsonqtn += " hiddenVarName_1:\'none\',";' . "\r\n" . '		}' . "\r\n" . '		if( in_array(2,theHiddenVarName) )' . "\r\n" . '		{' . "\r\n" . '			jsonqtn += " hiddenVarName_2:\'\',";' . "\r\n" . '		}' . "\r\n" . '		else' . "\r\n" . '		{' . "\r\n" . '			jsonqtn += " hiddenVarName_2:\'none\',";' . "\r\n" . '		}' . "\r\n" . '		if( in_array(3,theHiddenVarName) )' . "\r\n" . '		{' . "\r\n" . '			jsonqtn += " hiddenVarName_3:\'\'";' . "\r\n" . '		}' . "\r\n" . '		else' . "\r\n" . '		{' . "\r\n" . '			jsonqtn += " hiddenVarName_3:\'none\'";' . "\r\n" . '		}' . "\r\n" . '		theHiddenVarName = null;' . "\r\n" . '	}' . "\r\n" . '	jsonqtn += "}";' . "\r\n" . '' . "\r\n" . '	//处理页面字段' . "\r\n" . '	this_fields_list += \'option_\'+questionID+\'|\';' . "\r\n" . '	this_fields_type += \'3|\';' . "\r\n" . '	this_file_list += \'option_\'+questionID+\'|\';' . "\r\n" . '' . "\r\n" . '	if( count(dataRow.rows) != 0 )' . "\r\n" . '	{' . "\r\n" . '		if( dataRow.rows[0][dataIndex[\'option_\'+questionID]] != \'\' )' . "\r\n" . '		{' . "\r\n" . '			this_size_list += dataRow.rows[0][dataIndex[\'option_\'+questionID]]+\'###\'+theJoinTime+\'|\';' . "\r\n" . '		}' . "\r\n" . '		else' . "\r\n" . '		{' . "\r\n" . '			this_size_list += \'null###\'+theJoinTime+\'|\';' . "\r\n" . '		}			' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		this_size_list += \'null###\'+theJoinTime+\'|\';' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	//处理提交检查' . "\r\n" . '	var check_survey_form_no_con_list = \'\';' . "\r\n" . '	if( QtnListArray[questionID].isRequired == 1 )' . "\r\n" . '	{' . "\r\n" . '		check_survey_form_no_con_list += "\\tif (!CheckNotNull(document.Survey_Form."+\'option_\'+questionID+", \'"+theInfoQtnName+"\')){return false;} \\n";' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	//逻辑条件' . "\r\n" . '	var QuestionCon = _GetQuestionCond(questionID,qid);' . "\r\n" . '	if( QuestionCon != \'\' )' . "\r\n" . '	{' . "\r\n" . '		check_survey_conditions_list += "\\tif("+QuestionCon+")\\n\\t{\\n";' . "\r\n" . '		check_survey_conditions_list += "\\t\\t$(\'#question_"+questionID+"\').show();\\n\\t} \\n";' . "\r\n" . '		check_survey_conditions_list += "\\telse { \\n";' . "\r\n" . '		check_survey_conditions_list += "\\t\\t$(\'#question_"+questionID+"\').hide();\\n\\t} \\n";' . "\r\n" . '' . "\r\n" . '		check_form_list = "\\tif("+QuestionCon+")\\n\\t{\\n";' . "\r\n" . '		check_form_list += check_survey_form_no_con_list;' . "\r\n" . '		check_form_list += "\\t}\\n";' . "\r\n" . '		//移除已回复的值' . "\r\n" . '		check_form_list += "\\telse{\\n";' . "\r\n" . '		check_form_list +="\\tTextUnInput(document.Survey_Form.option_"+questionID+");\\n";' . "\r\n" . '		check_form_list += "\\t}\\n";' . "\r\n" . '' . "\r\n" . '		check_survey_form_list += check_form_list;' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		check_survey_form_list += check_survey_form_no_con_list;' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	var tplText = \'<table width="100%" class="pertable" id="question_{$questionID}"><tr><td class="question" valign=center>&nbsp;{$questionRequire}<span class="textEdit" id="questionName_{$questionID}">{$questionName}</span>&nbsp;<span class=notes>{$questionNotes}</span></td></tr><tr><td class="tips"><span class="textEdit" id="questionNotes_{$questionID}">{$questionTips}</span></td></tr><tr><td><table cellSpacing=0 cellPadding=0 width="100%"><tr><td class="answer tdheight" valign=center nowrap><input type="text" readonly id="{$optionID}" name="{$optionID}" size="{$length}" value="{$value}"/>&nbsp;<input type="button" name="takePic{$optionID}" id="takePic{$optionID}" value="&nbsp;&nbsp;拍照&nbsp;&nbsp;" class=btn onClick="javascript:takePic(\\\'{$optionID}\\\',{$questionID});" style="display:{$hiddenVarName_1}">&nbsp;<input type="button" name="takeViedo{$optionID}" id="takeViedo{$optionID}" class=btn value="&nbsp;&nbsp;录像&nbsp;&nbsp;" onClick="javascript:takeViedo(\\\'{$optionID}\\\');" style="display:{$hiddenVarName_2}">&nbsp;<input type="button" name="takeAudio{$optionID}" id="takeAudio{$optionID}" class=btn value="&nbsp;&nbsp;录音&nbsp;&nbsp;" onClick="javascript:takeAudio(\\\'{$optionID}\\\');" style="display:{$hiddenVarName_3}"></td></tr><tr><td id="fsUploadProgress_{$optionID}"></td></tr></table></td></tr></table>\';' . "\r\n" . '' . "\r\n" . '	var jsondata = eval(\'(\'+jsonqtn+\')\');' . "\r\n" . '	var t = new jSmart(tplText);' . "\r\n" . '	//$(\'#survey_content_container\').append( t.fetch(jsondata));  ' . "\r\n" . '    survey_content_container_html += t.fetch(jsondata);' . "\r\n" . '    jsondata = null;' . "\r\n" . '}' . "\r\n" . '' . "\r\n" . 'var uploadFlag = \'\';' . "\r\n" . 'function takePic(optionID,questionID){' . "\r\n" . '	var theTmpFilePath = rexseeStorage.getRoot()+\'enableq_offline/files/\'+qid+\'/\';' . "\r\n" . '	if( ! rexseeFile.exists(theTmpFilePath) )' . "\r\n" . '	{' . "\r\n" . '		rexseeFile.newDir(theTmpFilePath);' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	var txt = eval(\'document.getElementById("\'+optionID+\'")\');' . "\r\n" . '    txt.value = "";' . "\r\n" . '' . "\r\n" . '	uploadFlag = optionID;' . "\r\n" . '	rexseeCamera.takePicture(0,theTmpFilePath + questionID +\'_p_\'+nickUserId+\'_\'+date(\'YmdHis\',time())+\'.jpg\');' . "\r\n" . '}' . "\r\n" . 'function takeViedo(optionID){' . "\r\n" . '	' . "\r\n" . '	var theTmpFilePath = rexseeStorage.getRoot()+\'enableq_offline/files/\'+qid+\'/\';' . "\r\n" . '	if( ! rexseeFile.exists(theTmpFilePath) )' . "\r\n" . '	{' . "\r\n" . '		rexseeFile.newDir(theTmpFilePath);' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	var txt = eval(\'document.getElementById("\'+optionID+\'")\');' . "\r\n" . '    txt.value = "";' . "\r\n" . '' . "\r\n" . '	uploadFlag = optionID;' . "\r\n" . '	rexseeCamera.takeVideo(0);' . "\r\n" . '}' . "\r\n" . 'function takeAudio(optionID){' . "\r\n" . '	var theTmpFilePath = rexseeStorage.getRoot()+\'enableq_offline/files/\'+qid+\'/\';' . "\r\n" . '	if( ! rexseeFile.exists(theTmpFilePath) )' . "\r\n" . '	{' . "\r\n" . '		rexseeFile.newDir(theTmpFilePath);' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	var txt = eval(\'document.getElementById("\'+optionID+\'")\');' . "\r\n" . '    txt.value = "";' . "\r\n" . '' . "\r\n" . '	uploadFlag = optionID;' . "\r\n" . '	rexseeAudioRecorder.record();' . "\r\n" . '}' . "\r\n" . '' . "\r\n" . '//Viedo' . "\r\n" . 'function onTakeVideoSuccessed(path){' . "\r\n" . '	var theTmpFilePath = rexseeStorage.getRoot()+\'enableq_offline/files/\'+qid+\'/\';' . "\r\n" . '	' . "\r\n" . '	var tmpExt = basename(path).split(\'.\');' . "\r\n" . '	var tmpNum = count(tmpExt)-1;' . "\r\n" . '	var extension = strtolower(tmpExt[tmpNum]);' . "\r\n" . '' . "\r\n" . '	var theOptionID = uploadFlag.split(\'_\');' . "\r\n" . '' . "\r\n" . '	var theNewFileName = theOptionID[1]+\'_v_\'+nickUserId+\'_\'+date(\'YmdHis\',time())+\'.\'+extension+\'.qf\';' . "\r\n" . '	//删除旧的' . "\r\n" . '	if( rexseeFile.exists(theTmpFilePath+theNewFileName) )' . "\r\n" . '	{' . "\r\n" . '		rexseeFile.remove(theTmpFilePath+theNewFileName);' . "\r\n" . '	}' . "\r\n" . '	rexseeFile.renameTo(path,theTmpFilePath+theNewFileName );' . "\r\n" . '	var filename = theNewFileName;' . "\r\n" . '	var txt = eval(\'document.getElementById("\'+uploadFlag+\'")\');' . "\r\n" . '    txt.value = filename;' . "\r\n" . '	eval("document.getElementById(\'fsUploadProgress_"+uploadFlag+"\')").innerHTML = "<font color=red><b>录像成功</b></font>";' . "\r\n" . '	if( eval("document.getElementById(\'takePic"+uploadFlag+"\')") != null )' . "\r\n" . '	{' . "\r\n" . '		eval("document.getElementById(\'takePic"+uploadFlag+"\')").disabled = true;' . "\r\n" . '	}' . "\r\n" . '	if( eval("document.getElementById(\'takeViedo"+uploadFlag+"\')") != null )' . "\r\n" . '	{' . "\r\n" . '		eval("document.getElementById(\'takeViedo"+uploadFlag+"\')").disabled = true;' . "\r\n" . '	}' . "\r\n" . '	if( eval("document.getElementById(\'takeAudio"+uploadFlag+"\')") != null )' . "\r\n" . '	{' . "\r\n" . '		eval("document.getElementById(\'takeAudio"+uploadFlag+"\')").disabled = true;' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	//插入GPS轨迹' . "\r\n" . '	getGpsLastKnownLocation(theOptionID[1]);' . "\r\n" . '}' . "\r\n" . 'function onTakeVideoFailed(){' . "\r\n" . '	alert("可能因为放弃录像或者未选择保存导致的录像失败！");' . "\r\n" . '	eval("document.getElementById(\'fsUploadProgress_"+uploadFlag+"\')").innerHTML = "<font color=red><b>录像失败</b></font>";' . "\r\n" . '}' . "\r\n" . '' . "\r\n" . '//Image' . "\r\n" . 'function onTakePictureSuccessed(path){' . "\r\n" . '	' . "\r\n" . '	//压缩图片' . "\r\n" . '	rexseeImage.scaleByRate(path,0.5);' . "\r\n" . '	rexseeFile.renameTo(path,path+\'.qf\');' . "\r\n" . '	' . "\r\n" . '	//处理' . "\r\n" . '	var theTmpFilePath = rexseeStorage.getRoot()+\'enableq_offline/files/\'+qid+\'/\';' . "\r\n" . '	var filename = str_replace(theTmpFilePath,\'\',path)+\'.qf\';' . "\r\n" . '	var txt = eval(\'document.getElementById("\'+uploadFlag+\'")\');' . "\r\n" . '	txt.value = filename;' . "\r\n" . '	eval("document.getElementById(\'fsUploadProgress_"+uploadFlag+"\')").innerHTML = "<font color=red><b>拍照成功</b></font>";' . "\r\n" . '	if( eval("document.getElementById(\'takePic"+uploadFlag+"\')") != null )' . "\r\n" . '	{' . "\r\n" . '		eval("document.getElementById(\'takePic"+uploadFlag+"\')").disabled = true;' . "\r\n" . '	}' . "\r\n" . '	if( eval("document.getElementById(\'takeViedo"+uploadFlag+"\')") != null )' . "\r\n" . '	{' . "\r\n" . '		eval("document.getElementById(\'takeViedo"+uploadFlag+"\')").disabled = true;' . "\r\n" . '	}' . "\r\n" . '	if( eval("document.getElementById(\'takeAudio"+uploadFlag+"\')") != null )' . "\r\n" . '	{' . "\r\n" . '		eval("document.getElementById(\'takeAudio"+uploadFlag+"\')").disabled = true;' . "\r\n" . '	}' . "\r\n" . '	//插入GPS轨迹' . "\r\n" . '	var theOptionID = uploadFlag.split(\'_\');' . "\r\n" . '	getGpsLastKnownLocation(theOptionID[1]);' . "\r\n" . '}' . "\r\n" . 'function onTakePictureFailed(){' . "\r\n" . '	alert("可能因为放弃拍照或者未选择保存导致拍摄照片失败！");' . "\r\n" . '	eval("document.getElementById(\'fsUploadProgress_"+uploadFlag+"\')").innerHTML = "<font color=red><b>拍照失败</b></font>";' . "\r\n" . '}' . "\r\n" . '' . "\r\n" . '//Audio' . "\r\n" . 'function onRecordAudioSuccessed(path) {' . "\r\n" . '	var theTmpFilePath = rexseeStorage.getRoot()+\'enableq_offline/files/\'+qid+\'/\';' . "\r\n" . '	' . "\r\n" . '	var tmpExt = basename(path).split(\'.\');' . "\r\n" . '	var tmpNum = count(tmpExt)-1;' . "\r\n" . '	var extension = strtolower(tmpExt[tmpNum]);' . "\r\n" . '	var theOptionID = uploadFlag.split(\'_\');' . "\r\n" . '' . "\r\n" . '	var theNewFileName = theOptionID[1]+\'_l_\'+nickUserId+\'_\'+date(\'YmdHis\',time())+\'.\'+extension+\'.qf\';' . "\r\n" . '	//删除旧的' . "\r\n" . '	if( rexseeFile.exists(theTmpFilePath+theNewFileName) )' . "\r\n" . '	{' . "\r\n" . '		rexseeFile.remove(theTmpFilePath+theNewFileName);' . "\r\n" . '	}' . "\r\n" . '	rexseeFile.renameTo(path,theTmpFilePath+theNewFileName );' . "\r\n" . '	var filename = theNewFileName;' . "\r\n" . '	var txt = eval(\'document.getElementById("\'+uploadFlag+\'")\');' . "\r\n" . '    txt.value = filename;' . "\r\n" . '' . "\r\n" . '	eval("document.getElementById(\'fsUploadProgress_"+uploadFlag+"\')").innerHTML = "<font color=red><b>录音成功</b></font>";' . "\r\n" . '	if( eval("document.getElementById(\'takePic"+uploadFlag+"\')") != null )' . "\r\n" . '	{' . "\r\n" . '		eval("document.getElementById(\'takePic"+uploadFlag+"\')").disabled = true;' . "\r\n" . '	}' . "\r\n" . '	if( eval("document.getElementById(\'takeViedo"+uploadFlag+"\')") != null )' . "\r\n" . '	{' . "\r\n" . '		eval("document.getElementById(\'takeViedo"+uploadFlag+"\')").disabled = true;' . "\r\n" . '	}' . "\r\n" . '	if( eval("document.getElementById(\'takeAudio"+uploadFlag+"\')") != null )' . "\r\n" . '	{' . "\r\n" . '		eval("document.getElementById(\'takeAudio"+uploadFlag+"\')").disabled = true;' . "\r\n" . '	}' . "\r\n" . '	//插入GPS轨迹' . "\r\n" . '	getGpsLastKnownLocation(theOptionID[1]);' . "\r\n" . '}' . "\r\n" . 'function onRecordAudioFailed() {' . "\r\n" . '	alert("可能因为放弃录音或者未选择保存导致录音失败！");' . "\r\n" . '	eval("document.getElementById(\'fsUploadProgress_"+uploadFlag+"\')").innerHTML = "<font color=red><b>录音失败</b></font>";' . "\r\n" . '}' . "\r\n" . '';

?>
