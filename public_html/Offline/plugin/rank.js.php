<?php
//dezend by http://www.yunlu99.com/
echo 'function create_rank_qtn(questionID)' . "\r\n" . '{' . "\r\n" . '	var theInfoQtnName = qNoScriptString(QtnListArray[questionID].questionName);' . "\r\n" . '	var dataqtn = "{ ";' . "\r\n" . '' . "\r\n" . '	if( QtnListArray[questionID].isHaveOther == 1 )' . "\r\n" . '	{' . "\r\n" . '		dataqtn += " isHaveOther:\'\',";' . "\r\n" . '		dataqtn += " otherText:\'"+qJsonCharFilter(QtnListArray[questionID].otherText)+"\',";' . "\r\n" . '		dataqtn += " other_OptionID:\'option_"+questionID+"_0\',";' . "\r\n" . '		if( count(dataRow.rows) != 0 )' . "\r\n" . '		{' . "\r\n" . '			if( dataRow.rows[0][dataIndex[\'option_\'+questionID+\'_0\']] != \'0\' )' . "\r\n" . '			{' . "\r\n" . '				dataqtn += " other_value:\'"+dataRow.rows[0][dataIndex[\'option_\'+questionID+\'_0\']]+"\',";' . "\r\n" . '			}' . "\r\n" . '			else' . "\r\n" . '			{' . "\r\n" . '				dataqtn += " other_value:\'\',";' . "\r\n" . '			}' . "\r\n" . '		}' . "\r\n" . '		else' . "\r\n" . '		{' . "\r\n" . '			dataqtn += " other_value:\'\',";' . "\r\n" . '		}' . "\r\n" . '		if( count(dataRow.rows) != 0 )' . "\r\n" . '		{' . "\r\n" . '			dataqtn += " TextOtherValue:\'"+qhtmlspecialchars(dataRow.rows[0][dataIndex[\'TextOtherValue_\'+questionID]])+"\',";' . "\r\n" . '		}' . "\r\n" . '		else' . "\r\n" . '		{' . "\r\n" . '			dataqtn += " TextOtherValue:\'\',";' . "\r\n" . '		}' . "\r\n" . '' . "\r\n" . '		//处理页面字段' . "\r\n" . '		this_fields_list += \'option_\'+questionID+\'_0\'+\'|\';' . "\r\n" . '		this_fields_type += \'3|\';' . "\r\n" . '		this_fields_list += \'TextOtherValue_\'+questionID+\'|\';' . "\r\n" . '		this_fields_type += \'3|\';' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		dataqtn += " isHaveOther:\'none\',";' . "\r\n" . '		dataqtn += " otherText:\'\',";' . "\r\n" . '		dataqtn += " other_OptionID:\'option_"+questionID+"_0\',";' . "\r\n" . '		dataqtn += " other_value:\'\',";' . "\r\n" . '		dataqtn += " TextOtherValue:\'\',";' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	if( QtnListArray[questionID].isHaveWhy == 1 )' . "\r\n" . '	{' . "\r\n" . '		dataqtn += " isHaveWhy:\'\',";' . "\r\n" . '		if( count(dataRow.rows) != 0 )' . "\r\n" . '		{' . "\r\n" . '			dataqtn += " TextWhyValue:\'"+qhtmlspecialchars(dataRow.rows[0][dataIndex[\'TextWhyValue_\'+questionID]])+"\',";' . "\r\n" . '		}' . "\r\n" . '		else' . "\r\n" . '		{' . "\r\n" . '			dataqtn += " TextWhyValue:\'\',";' . "\r\n" . '		}' . "\r\n" . '' . "\r\n" . '		//处理页面字段' . "\r\n" . '		this_fields_list += \'TextWhyValue_\'+questionID+\'|\';' . "\r\n" . '		this_fields_type += \'4|\';' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		dataqtn += " isHaveWhy:\'none\',";' . "\r\n" . '		dataqtn += " TextWhyValue:\'\',";' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	//显示题目名称' . "\r\n" . '	var questionRequire = \'\';' . "\r\n" . '	var questionName = \'\';' . "\r\n" . '	var questionNotes = \'\';' . "\r\n" . '	var minOption = maxOption = \'\';' . "\r\n" . '	if( QtnListArray[questionID].isRequired == 1 )' . "\r\n" . '	{' . "\r\n" . '		questionRequire = \'<span class=red>*</span>\';' . "\r\n" . '		if( QtnListArray[questionID].minOption != 0 )' . "\r\n" . '		{' . "\r\n" . '		   minOption = \'[最少\'+QtnListArray[questionID].minOption+\'项]\';' . "\r\n" . '		}' . "\r\n" . '		if( QtnListArray[questionID].maxOption != 0 )' . "\r\n" . '		{' . "\r\n" . '		   maxOption = \'[最多\'+QtnListArray[questionID].maxOption+\'项]\';' . "\r\n" . '		}' . "\r\n" . '	}' . "\r\n" . '	questionName = qQuotaChar(qJsonCharFilter(QtnListArray[questionID].questionName));' . "\r\n" . '	questionNotes = \'[排序题]\';' . "\r\n" . '	questionNotes += minOption;' . "\r\n" . '	questionNotes += maxOption;' . "\r\n" . '' . "\r\n" . '    dataqtn += " questionID: "+questionID+",";' . "\r\n" . '    dataqtn += " questionRequire: \'"+questionRequire+"\',";' . "\r\n" . '    dataqtn += " questionName: \'"+qShowQtnName(questionName,questionID,1)+"\',";' . "\r\n" . '    dataqtn += " questionNotes: \'"+questionNotes+"\',";' . "\r\n" . '	questionTips = qQuotaChar(qJsonCharFilter(QtnListArray[questionID].questionNotes));' . "\r\n" . '    dataqtn += " questionTips: \'"+qShowQtnName(questionTips,questionID,2)+"\',";' . "\r\n" . '' . "\r\n" . '	//显示排序项' . "\r\n" . '	var optionTotalNum = count(RankListArray[questionID]);' . "\r\n" . '	var theRankListArray = [];' . "\r\n" . '	if( QtnListArray[questionID].isRandOptions == 1 ) //随机' . "\r\n" . '	{' . "\r\n" . '		 var tmpArray = [];' . "\r\n" . '		 for(var tmp in RankListArray[questionID] )' . "\r\n" . '		 {' . "\r\n" . '			 tmpArray.push(tmp);' . "\r\n" . '		 }' . "\r\n" . '		 var theRandListArray = array_rand(tmpArray,optionTotalNum);' . "\r\n" . '		 for( var i=0;i<theRandListArray.length;i++)' . "\r\n" . '		 {' . "\r\n" . '			 theRankListArray.push(tmpArray[theRandListArray[i]]);' . "\r\n" . '		 }' . "\r\n" . '		 tmpArray = null;' . "\r\n" . '		 theRandListArray = null;' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		 for( var tmp in RankListArray[questionID] )' . "\r\n" . '		 {' . "\r\n" . '			theRankListArray.push(tmp);' . "\r\n" . '		 }' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	//有其他项' . "\r\n" . '	var theOrderMaxNum = optionTotalNum;' . "\r\n" . '	if( QtnListArray[questionID].isHaveOther == 1 )' . "\r\n" . '	{' . "\r\n" . '		theOrderMaxNum ++;' . "\r\n" . '		dataqtn += " other_endScale: \'"+theOrderMaxNum+"\',";' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		dataqtn += " other_endScale: \'\',";' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '    dataqtn += " qtns:[ ";' . "\r\n" . '	for( var k in theRankListArray )' . "\r\n" . '	{' . "\r\n" . '		var question_rankID = theRankListArray[k];' . "\r\n" . '		var theQuestionArray = RankListArray[questionID][question_rankID];' . "\r\n" . '' . "\r\n" . '		this_fields_list += \'option_\'+questionID+\'_\'+question_rankID+\'|\';' . "\r\n" . '		this_fields_type += \'3|\';' . "\r\n" . '' . "\r\n" . '		dataqtn += "{";' . "\r\n" . '		dataqtn += " optionName: \'"+qJsonCharFilter(theQuestionArray.optionName)+"\',";' . "\r\n" . '		dataqtn += " optionID: \'option_"+questionID+\'_\'+question_rankID+"\',";' . "\r\n" . '		dataqtn += " rankID: \'"+question_rankID+"\',";' . "\r\n" . '		if( count(dataRow.rows) != 0 )' . "\r\n" . '		{' . "\r\n" . '			if( dataRow.rows[0][dataIndex[\'option_\'+questionID+\'_\'+question_rankID]] != \'0\' )' . "\r\n" . '			{' . "\r\n" . '				dataqtn += " value:\'"+dataRow.rows[0][dataIndex[\'option_\'+questionID+\'_\'+question_rankID]]+"\',";' . "\r\n" . '			}' . "\r\n" . '			else' . "\r\n" . '			{' . "\r\n" . '				dataqtn += " value:\'\',";' . "\r\n" . '			}' . "\r\n" . '		}' . "\r\n" . '		else' . "\r\n" . '		{' . "\r\n" . '			dataqtn += " value:\'\',";' . "\r\n" . '		}' . "\r\n" . '		dataqtn += " endScale: \'"+theOrderMaxNum+"\'";' . "\r\n" . '		dataqtn += "},";' . "\r\n" . '' . "\r\n" . '		//矩阵行关联' . "\r\n" . '		QtnAssCon = _GetQtnAssCond(questionID,question_rankID);' . "\r\n" . '		if( QtnAssCon != \'\' )' . "\r\n" . '		{' . "\r\n" . '			check_survey_conditions_list += "\\tif("+QtnAssCon+")\\n\\t{\\n";' . "\r\n" . '			check_survey_conditions_list += "\\t\\t$(\\"#range_rank_"+question_rankID+"_container\\").hide();\\n";			' . "\r\n" . '			check_survey_conditions_list += "\\t\\tTextUnInput(document.Survey_Form.option_"+questionID+\'_\'+question_rankID+");\\n";' . "\r\n" . '			check_survey_conditions_list += "\\t} \\n";' . "\r\n" . '			check_survey_conditions_list += "\\telse { \\n";' . "\r\n" . '			check_survey_conditions_list += "\\t\\t$(\\"#range_rank_"+question_rankID+"_container\\").show();\\n\\t} \\n";' . "\r\n" . '		}' . "\r\n" . '	}' . "\r\n" . '	dataqtn = dataqtn.substr(0,dataqtn.length-1)+"] }";' . "\r\n" . '' . "\r\n" . '	//处理检查项' . "\r\n" . '	var check_survey_form_no_con_list = \'\';' . "\r\n" . '	//判断排序号合法值' . "\r\n" . '	check_survey_form_no_con_list += "\\tif (!CheckRank("+questionID+",\'"+theInfoQtnName+"\',"+QtnListArray[questionID].isRequired+","+QtnListArray[questionID].minOption+","+QtnListArray[questionID].maxOption+")){return false;}\\n ";' . "\r\n" . '' . "\r\n" . '	if( QtnListArray[questionID].isRequired == 1 )' . "\r\n" . '	{' . "\r\n" . '		if( QtnListArray[questionID].isHaveOther == 1 )' . "\r\n" . '		{' . "\r\n" . '		    check_survey_form_no_con_list += "\\tif (document.Survey_Form."+\'option_\'+questionID+\'_0\'+".value != \'\' )\\n\\t{\\n\\t\\tif(!CheckNotNull(document.Survey_Form.TextOtherValue_"+questionID+", \'"+theInfoQtnName+" - "+qNoScriptString(QtnListArray[questionID].otherText)+"\')){return false;}\\n\\t}\\n";' . "\r\n" . '			check_survey_form_no_con_list += "\\telse{\\n\\t\\tTextUnInput(document.Survey_Form.TextOtherValue_"+questionID+");\\n\\t}\\n";' . "\r\n" . '		}' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	if( QtnListArray[questionID].isRequired == 1 && QtnListArray[questionID].isHaveWhy == 1 )' . "\r\n" . '	{' . "\r\n" . '		check_survey_form_no_con_list += "\\tif (!CheckNotNull(document.Survey_Form.TextWhyValue_"+questionID+", \'"+theInfoQtnName+" - 为什么这么排序\')){return false;} \\n";' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	//逻辑条件' . "\r\n" . '	var QuestionCon = _GetQuestionCond(questionID,qid);' . "\r\n" . '	if( QuestionCon != \'\' )' . "\r\n" . '	{' . "\r\n" . '		check_survey_conditions_list += "\\tif("+QuestionCon+")\\n\\t{\\n";' . "\r\n" . '		check_survey_conditions_list += "\\t\\t$(\'#question_"+questionID+"\').show();\\n\\t} \\n";' . "\r\n" . '		check_survey_conditions_list += "\\telse { \\n";' . "\r\n" . '		check_survey_conditions_list += "\\t\\t$(\'#question_"+questionID+"\').hide();\\n\\t} \\n";' . "\r\n" . '' . "\r\n" . '		var check_form_list = "\\tif("+QuestionCon+")\\n\\t{\\n";' . "\r\n" . '		check_form_list += check_survey_form_no_con_list;' . "\r\n" . '		check_form_list += "\\t}\\n";' . "\r\n" . '		//移除已回复的值' . "\r\n" . '		check_form_list += "\\telse{\\n";' . "\r\n" . '		check_form_list += "\\t\\tRankUnInput("+questionID+");";' . "\r\n" . '		if( QtnListArray[questionID].isHaveOther == 1 )' . "\r\n" . '		{' . "\r\n" . '			check_form_list += "\\tTextUnInput(document.Survey_Form.TextOtherValue_"+questionID+");\\n";' . "\r\n" . '		}' . "\r\n" . '		if( QtnListArray[questionID].isHaveWhy == 1 )' . "\r\n" . '		{' . "\r\n" . '			check_form_list += "\\tTextUnInput(document.Survey_Form.TextWhyValue_"+questionID+");\\n";' . "\r\n" . '		}' . "\r\n" . '		check_form_list += "\\t}\\n";		' . "\r\n" . '		check_survey_form_list += check_form_list;' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		check_survey_form_list += check_survey_form_no_con_list;' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	var tplText = \'<table width="100%" class="pertable" id="question_{$questionID}"><tr><td class="question" valign=center>&nbsp;{$questionRequire}<span class="textEdit" id="questionName_{$questionID}">{$questionName}</span>&nbsp;<span class=notes>{$questionNotes}</span></td></tr><tr><td class="tips"><span class="textEdit" id="questionNotes_{$questionID}">{$questionTips}</span></td></tr><tr><td><table cellSpacing=0 cellPadding=0 width=100% id="qtn_table_{$questionID}">{foreach $qtns as $i => $qtn}<tr id="range_rank_{$qtn.rankID}_container"><td class="answer tdheight optcont" align="left" valign=center nowrap><input type="hidden" name="{$qtn.optionID}" id="{$qtn.optionID}" value="{$qtn.value}" class="sortinput"><span class="sortnum"></span>&nbsp;<span class="textEdit" id="optionName_10_{$questionID}_{$qtn.rankID}">{$qtn.optionName}</span></td></tr>{/foreach}<tr style="display:{$isHaveOther}" class=tdheight id="range_rank_{$questionID}_0_container"><td class="answer optcont" valign=center nowrap><input type="hidden" name="{$other_OptionID}" id="{$other_OptionID}" value="{$other_value}" class="sortinput"><span class="sortnum"></span>&nbsp;<span class="textEdit" id="optionName_10_{$questionID}_0">{$otherText}</span>：<input name="TextOtherValue_{$questionID}" type="text" id="TextOtherValue_{$questionID}" value="{$TextOtherValue}">&nbsp;(请说明)</td></tr><tr style="display:{$isHaveWhy}" class="no_color_tr"><td class="answer tdheight" valign=center nowrap>请问为什么这么排序?<br/><textarea rows=5 cols=80 name="TextWhyValue_{$questionID}" id="TextWhyValue_{$questionID}">{$TextWhyValue}</textarea></td></tr></table></td></tr></table>\';' . "\r\n" . '' . "\r\n" . '	//问卷结束条件' . "\r\n" . '	var EndSurveyCon = _GetSurveyQuotaCond(questionID,qid,\'cn\');' . "\r\n" . '	if( EndSurveyCon != \'\' )' . "\r\n" . '	{' . "\r\n" . '		survey_quota_list += EndSurveyCon;' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	//改变背景颜色' . "\r\n" . '	check_survey_conditions_list += "\\tchangeMaskingSingleBgColor("+questionID+");\\n";' . "\r\n" . '' . "\r\n" . '    var jsondata = eval(\'(\'+dataqtn+\')\');' . "\r\n" . '	var t = new jSmart(tplText);' . "\r\n" . '	//$(\'#survey_content_container\').append( t.fetch(jsondata)); ' . "\r\n" . '	survey_content_container_html += t.fetch(jsondata);' . "\r\n" . '	jsondata = null;' . "\r\n" . '	theQuestionArray = null;' . "\r\n" . '}' . "\r\n" . '' . "\r\n" . '//判断排序' . "\r\n" . 'function CheckRank(questionID,strText,isRequired,minOption,maxOption)' . "\r\n" . '{' . "\r\n" . '	if( isRequired == 1 )' . "\r\n" . '	{' . "\r\n" . '		var isOrder = 0;' . "\r\n" . '		$("#qtn_table_"+questionID).find("td.optcont").each(function(){' . "\r\n" . '			var v = $(this).find("input.sortinput").val();' . "\r\n" . '			if(	v != \'\' ){' . "\r\n" . '				isOrder++;' . "\r\n" . '			}' . "\r\n" . '		});' . "\r\n" . '        if( minOption != 0 )' . "\r\n" . '		{		' . "\r\n" . '			if( isOrder < minOption)' . "\r\n" . '			{' . "\r\n" . '				showMessage( strText + "最少必须进行" + minOption + "项排序");' . "\r\n" . '				return false;' . "\r\n" . '			}' . "\r\n" . '		}' . "\r\n" . '		else' . "\r\n" . '		{' . "\r\n" . '		   if( isOrder < 1 )' . "\r\n" . '		   {' . "\r\n" . '				showMessage( strText + "最少必须进行1项排序");' . "\r\n" . '				return false;' . "\r\n" . '			}' . "\r\n" . '		}' . "\r\n" . '        if( maxOption != 0 )' . "\r\n" . '		{		' . "\r\n" . '			if( isOrder > maxOption)' . "\r\n" . '			{' . "\r\n" . '				showMessage( strText + "最多只能进行" + maxOption + "项排序");' . "\r\n" . '				return false;' . "\r\n" . '			}' . "\r\n" . '		}' . "\r\n" . '	}' . "\r\n" . '	return true;' . "\r\n" . '}' . "\r\n" . '' . "\r\n" . '//移除排序题的值' . "\r\n" . 'function RankUnInput(questionID)' . "\r\n" . '{' . "\r\n" . '	$("#qtn_table_"+questionID).find("td.optcont").each(function(){' . "\r\n" . '		var v = $(this).find("input.sortinput").val(\'\');' . "\r\n" . '	});' . "\r\n" . '}';

?>
