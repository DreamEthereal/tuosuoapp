<?php
//dezend by http://www.yunlu99.com/
echo 'function create_cond_qtn(questionID)' . "\r\n" . '{' . "\r\n" . '	var theInfoQtnName = qNoScriptString(QtnListArray[questionID].questionName);' . "\r\n" . '	this_fields_list += \'option_\'+questionID+\'|\';' . "\r\n" . '	this_fields_type += \'5|\';' . "\r\n" . '' . "\r\n" . '	//提交检查' . "\r\n" . '	var questionRequire = \'\';' . "\r\n" . '	var questionName = \'\';' . "\r\n" . '	var questionNotes = \'\';' . "\r\n" . '	var minOption = \'\',maxOption = \'\';' . "\r\n" . '	var check_survey_form_no_con_list = \'\';' . "\r\n" . '' . "\r\n" . '	if( QtnListArray[questionID].isRequired == 1 )' . "\r\n" . '	{' . "\r\n" . '		var questionRequire = \'<span class=red>*</span>\';' . "\r\n" . '		check_survey_form_no_con_list += "\\tif (!CheckListNoSelect(document.Survey_Form."+\'option_\'+questionID+", \'"+theInfoQtnName+"\')){return false;} \\n";' . "\r\n" . '		if( QtnListArray[questionID].isSelect == 1) //多选' . "\r\n" . '		{' . "\r\n" . '			if( QtnListArray[questionID].minOption != 0 )' . "\r\n" . '			{' . "\r\n" . '			    minOption = \'[最少\'+QtnListArray[questionID].minOption+\'项]\';' . "\r\n" . '			}' . "\r\n" . '			if( QtnListArray[questionID].maxOption != 0 )' . "\r\n" . '			{' . "\r\n" . '			    maxOption = \'[最多\'+QtnListArray[questionID].maxOption+\'项]\';' . "\r\n" . '			}' . "\r\n" . '			if( QtnListArray[questionID].minOption != 0 )' . "\r\n" . '			{' . "\r\n" . '				check_survey_form_no_con_list += "\\tif (!CheckListMinSelect(document.Survey_Form."+\'option_\'+questionID+", \'"+theInfoQtnName+"\',"+QtnListArray[questionID].minOption+")){return false;} \\n";' . "\r\n" . '			}' . "\r\n" . '			if( QtnListArray[questionID].maxOption != 0 )' . "\r\n" . '			{' . "\r\n" . '				check_survey_form_no_con_list += "\\tif (!CheckListMaxSelect(document.Survey_Form."+\'option_\'+questionID+", \'"+theInfoQtnName+"\',"+QtnListArray[questionID].maxOption+")){return false;} \\n";' . "\r\n" . '			}' . "\r\n" . '		}' . "\r\n" . '	}' . "\r\n" . '	//展现问题文字' . "\r\n" . '	var questionName = qQuotaChar(qJsonCharFilter(QtnListArray[questionID].questionName));' . "\r\n" . '	questionNotes = \'[条件选项题]\';' . "\r\n" . '	questionNotes += minOption;' . "\r\n" . '	questionNotes += maxOption;' . "\r\n" . '' . "\r\n" . '    var dataqtn = "{ ";' . "\r\n" . '    dataqtn += " questionID: "+questionID+",";' . "\r\n" . '    dataqtn += " questionRequire: \'"+questionRequire+"\',";' . "\r\n" . '    dataqtn += " questionName: \'"+qShowQtnName(questionName,questionID,1)+"\',";' . "\r\n" . '    dataqtn += " questionNotes: \'"+questionNotes+"\',";' . "\r\n" . '	questionTips = qQuotaChar(qJsonCharFilter(QtnListArray[questionID].questionNotes));' . "\r\n" . '    dataqtn += " questionTips: \'"+qShowQtnName(questionTips,questionID,2)+"\',";' . "\r\n" . '' . "\r\n" . '	//逻辑条件' . "\r\n" . '	var QuestionCon = _GetQuestionCond(questionID,qid);' . "\r\n" . '	if( QuestionCon != \'\' )' . "\r\n" . '	{' . "\r\n" . '		check_survey_conditions_list += "\\tif("+QuestionCon+")\\n\\t{\\n";' . "\r\n" . '		check_survey_conditions_list += "\\t\\t$(\'#question_"+questionID+"\').show();\\n\\t} \\n";' . "\r\n" . '		check_survey_conditions_list += "\\telse { \\n";' . "\r\n" . '		check_survey_conditions_list += "\\t\\t$(\'#question_"+questionID+"\').hide();\\n\\t} \\n";' . "\r\n" . '' . "\r\n" . '		var check_form_list = "\\tif("+QuestionCon+")\\n\\t{\\n";' . "\r\n" . '		check_form_list += check_survey_form_no_con_list;' . "\r\n" . '		check_form_list += "\\t}\\n";' . "\r\n" . '		//移除已回复的值' . "\r\n" . '		check_form_list += "\\telse{\\n";' . "\r\n" . '		check_form_list +="\\tListUnSelect(document.Survey_Form.option_"+questionID+");\\n";' . "\r\n" . '		check_form_list += "\\t}\\n";' . "\r\n" . '		check_survey_form_list += check_form_list;' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		check_survey_form_list += check_survey_form_no_con_list;' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	//处理Select展现' . "\r\n" . '	if( QtnListArray[questionID].isSelect == 1) //多选' . "\r\n" . '	{' . "\r\n" . '		var optionSelect = "<select name=\\"option_"+questionID+"\\" id=\\"option_"+questionID+"\\" size=8 multiple></select>";' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		var optionSelect = "<select name=\\"option_"+questionID+"\\" id=\\"option_"+questionID+"\\" onchange=\\"jQuery.Check_Survey_Conditions();\\"></select>";' . "\r\n" . '	}' . "\r\n" . '    dataqtn += " optionSelect: \'"+optionSelect+"\'";' . "\r\n" . '    dataqtn += " }";' . "\r\n" . '' . "\r\n" . '	//来源问题及选项' . "\r\n" . '	var theBaseID = QtnListArray[questionID].baseID;' . "\r\n" . '	var theBaseQtnArray = QtnListArray[theBaseID];' . "\r\n" . '	var theRadioListArray = RadioListArray[theBaseQtnArray.questionID];' . "\r\n" . '' . "\r\n" . '	//来源问题不存在' . "\r\n" . '	if( count(theBaseQtnArray)==0 && QtnListArray[questionID].isRequired == 1)' . "\r\n" . '	{' . "\r\n" . '		check_survey_form_no_con_list += "\\tshowMessage(\'"+theInfoQtnName+"，来源问题不存在或已被删除\');return false;\\n";' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	var optionAutoArray = [];' . "\r\n" . '	for( var question_radioID in theRadioListArray )' . "\r\n" . '	{' . "\r\n" . '		optionAutoArray[question_radioID] = theRadioListArray[question_radioID].optionName;' . "\r\n" . '	}' . "\r\n" . '	//有其他项' . "\r\n" . '	if( theBaseQtnArray.isHaveOther == 1 )' . "\r\n" . '	{' . "\r\n" . '		optionAutoArray[0] = theBaseQtnArray.otherText;' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	var theOptionList = \'\';' . "\r\n" . '	//theBaseOptionID||||theOptionValue1,theOptionValue2&&&&theOptionText1####theOptionText2****' . "\r\n" . '	for( var optionAutoID in optionAutoArray )' . "\r\n" . '	{' . "\r\n" . '		theOptionList += optionAutoID+\'||||\';' . "\r\n" . '' . "\r\n" . '		//ID串' . "\r\n" . '		var theOptionIDList = \'\',theOptionNameList=\'\';' . "\r\n" . '		for( var tmp in CondRadioListArray[questionID][optionAutoID])' . "\r\n" . '		{' . "\r\n" . '			var question_yesnoID = CondRadioListArray[questionID][optionAutoID][tmp];' . "\r\n" . '			theOptionIDList += question_yesnoID+\',\';' . "\r\n" . '			theOptionNameList += qJsonCharFilter(YesNoListArray[questionID][question_yesnoID].optionName)+\'####\';' . "\r\n" . '		}' . "\r\n" . '		theOptionList += substr(theOptionIDList,0,-1)+\'&&&&\';' . "\r\n" . '		theOptionList += substr(theOptionNameList,0,-4)+\'****\';' . "\r\n" . '	}' . "\r\n" . '	theOptionList = substr(theOptionList,0,-4);' . "\r\n" . '' . "\r\n" . '	//记录原选中的值' . "\r\n" . '	var theOriValue = \'\';' . "\r\n" . '	if( count(dataRow.rows) != 0 )' . "\r\n" . '	{' . "\r\n" . '		if( dataRow.rows[0][dataIndex[\'option_\'+questionID]] != \'\' )' . "\r\n" . '		{' . "\r\n" . '			theOriValue = dataRow.rows[0][dataIndex[\'option_\'+questionID]];' . "\r\n" . '		}' . "\r\n" . '	}' . "\r\n" . '	//选项生成' . "\r\n" . '	if( count(theBaseQtnArray) !=0  && ! IsSamePage(questionID,theBaseID) )  //不在同页' . "\r\n" . '	{' . "\r\n" . '		var theBaseValue = \'\';' . "\r\n" . '		if( count(dataRow.rows) != 0 )' . "\r\n" . '		{' . "\r\n" . '			if( dataRow.rows[0][dataIndex[\'option_\'+theBaseID]] != \'\' )' . "\r\n" . '			{' . "\r\n" . '				theBaseValue = dataRow.rows[0][dataIndex[\'option_\'+theBaseID]];' . "\r\n" . '			}' . "\r\n" . '		}' . "\r\n" . '		check_survey_conditions_list += "\\tgetCondOptionNoSamePage(\'"+theBaseValue+"\',"+questionID+",\'"+theOriValue+"\',\'"+theOptionList+"\');\\n";' . "\r\n" . '	}' . "\r\n" . '	else   //同页' . "\r\n" . '	{' . "\r\n" . '		var theBaseIsSelect = (count(theBaseQtnArray) ==0 ) ? 0 : theBaseQtnArray.isSelect;' . "\r\n" . '		check_survey_conditions_list += "\\tgetCondOptionSamePage("+theBaseID+","+questionID+","+theBaseIsSelect+",\'"+theOriValue+"\',\'"+theOptionList+"\');\\n";' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	var tplText = \'<table width="100%" class="pertable" id="question_{$questionID}"><tr><td class="question" valign=center>&nbsp;{$questionRequire}<span class="textEdit" id="questionName_{$questionID}">{$questionName}</span>&nbsp;<span class=notes>{$questionNotes}</span></td></tr><tr><td class="tips"><span class="textEdit" id="questionNotes_{$questionID}">{$questionTips}</span></td></tr><tr rel="eqprint"><td><table cellSpacing=0 cellPadding=0 width="98%"><tr><td class="answer">{$optionSelect}</td></tr></table></td></tr></table>\';' . "\r\n" . '' . "\r\n" . '	//关联关系' . "\r\n" . '	var RelSurveyCon = _GetSurveyValueRelationCond(questionID,qid,\'cn\');' . "\r\n" . '	if( RelSurveyCon != \'\' )' . "\r\n" . '	{' . "\r\n" . '		//此题存在多个数值关联关系的检查点' . "\r\n" . '		var theRelSurveyCon = RelSurveyCon.split(\'$$$$$$\');' . "\r\n" . '		for( var t in theRelSurveyCon )' . "\r\n" . '		{' . "\r\n" . '			var tRelSurveyCon = theRelSurveyCon[t].split(\'######\');' . "\r\n" . '			if( parseInt(tRelSurveyCon[0]) == 2 ) //空题' . "\r\n" . '			{' . "\r\n" . '				survey_empty_list += tRelSurveyCon[1];' . "\r\n" . '				var theEmptyList = tRelSurveyCon[1].split(\'*\');' . "\r\n" . '				var theEmptyId = parseInt(substr(theEmptyList[7],0,-3));' . "\r\n" . '				if( !IsSamePage(theEmptyId,questionID)) //不在同页' . "\r\n" . '				{' . "\r\n" . '					//空题字段' . "\r\n" . '					this_fields_list += \'option_\'+theEmptyId+\'|\';' . "\r\n" . '					this_fields_type += \'3|\';' . "\r\n" . '					//跑一遍空题的配额表达式' . "\r\n" . '					var theEmptyEndSurveyCon = _GetSurveyQuotaCond(theEmptyId,qid,\'cn\');' . "\r\n" . '					if( theEmptyEndSurveyCon != \'\' )' . "\r\n" . '					{' . "\r\n" . '						survey_quota_list += theEmptyEndSurveyCon;' . "\r\n" . '					}' . "\r\n" . '				}' . "\r\n" . '				theEmptyList = null;' . "\r\n" . '			}' . "\r\n" . '			else' . "\r\n" . '			{' . "\r\n" . '				survey_quota_list += tRelSurveyCon[1];' . "\r\n" . '			}' . "\r\n" . '			tRelSurveyCon = null;' . "\r\n" . '		}' . "\r\n" . '		theRelSurveyCon = null;' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '    var t = new jSmart(tplText);' . "\r\n" . '    var jsondata = eval(\'(\'+dataqtn+\')\');' . "\r\n" . '    //$(\'#survey_content_container\').append( t.fetch(jsondata)); ' . "\r\n" . '    survey_content_container_html += t.fetch(jsondata);' . "\r\n" . '    jsondata = null;' . "\r\n" . '	optionAutoArray = null;' . "\r\n" . '	theBaseQtnArray = null;' . "\r\n" . '	theRadioListArray = null;' . "\r\n" . '}' . "\r\n" . '' . "\r\n" . ' //theOptionList格式' . "\r\n" . ' //theBaseOptionID||||theOptionValue1,theOptionValue2&&&&theOptionText1####theOptionText2****' . "\r\n" . ' function getCondOptionSamePage(theBaseID,theID,isList,theOriValue,theOptionList){' . "\r\n" . '  ' . "\r\n" . '   var theBaseObj =  eval("document.Survey_Form.option_"+theBaseID );' . "\r\n" . '   var theObj =  eval("document.getElementById(\\"option_"+theID + "\\")");' . "\r\n" . '   var theBaseOptionIDArray,theOptionGroup,theOptionTextValueArray,theOptinValue,theOptionText;' . "\r\n" . '   var theItemOptionIDList;' . "\r\n" . '   var isTheOriList = false;' . "\r\n" . '' . "\r\n" . '   if( theBaseObj != null )' . "\r\n" . '   {' . "\r\n" . '		theBaseOptionIDArray = theOptionList.split(\'****\');' . "\r\n" . '		for(k=0;k<=theBaseOptionIDArray.length-1;k++)' . "\r\n" . '		{' . "\r\n" . '			theOptionGroup = theBaseOptionIDArray[k].split(\'||||\');' . "\r\n" . '			if( isList == 1)  //下拉' . "\r\n" . '			{' . "\r\n" . '               if( IsInSelectedList(theBaseObj,theOptionGroup[0]) ) {' . "\r\n" . '				     //值与文本联合字符串数组' . "\r\n" . '					 theOptionTextValueArray = theOptionGroup[1].split(\'&&&&\');' . "\r\n" . '					 //值数组' . "\r\n" . '					 theOptinValue = theOptionTextValueArray[0].split(\',\');' . "\r\n" . '					 //查原有ID是否在数组中' . "\r\n" . '					 theOptionTextValueListStr = \',\' + theOptionTextValueArray[0] + \',\';' . "\r\n" . '					 for( m=0;m<theObj.options.length;m++ ) { ' . "\r\n" . '						if( theOptionTextValueListStr.indexOf(","+  theObj.options[m].value + ",") != -1 )' . "\r\n" . '						{' . "\r\n" . '						    isTheOriList = true;' . "\r\n" . '							break;' . "\r\n" . '						}' . "\r\n" . '					 }' . "\r\n" . '					 if( isTheOriList == false )' . "\r\n" . '					 {' . "\r\n" . '						 //文本数组' . "\r\n" . '						 theOptionText = theOptionTextValueArray[1].split(\'####\');' . "\r\n" . '						 //清空所有的Options' . "\r\n" . '						 theObj.options.length=0;' . "\r\n" . '						 theObj.options.add(new Option(\'请选择...\',\'\')); ' . "\r\n" . '						 for(j=0;j<=theOptinValue.length-1;j++){' . "\r\n" . '							theObj.options.add(new Option(theOptionText[j],theOptinValue[j])); ' . "\r\n" . '						 }' . "\r\n" . '					 }' . "\r\n" . '			    } //end for if' . "\r\n" . '			}' . "\r\n" . '			else' . "\r\n" . '			{' . "\r\n" . '                if( IsInCheckBox(theBaseObj,theOptionGroup[0]) ) {' . "\r\n" . '				     //值与文本联合字符串数组' . "\r\n" . '					 theOptionTextValueArray = theOptionGroup[1].split(\'&&&&\');' . "\r\n" . '					 //值数组' . "\r\n" . '					 theOptinValue = theOptionTextValueArray[0].split(\',\');' . "\r\n" . '					 //查原有ID是否在数组中' . "\r\n" . '					 theOptionTextValueListStr = \',\' + theOptionTextValueArray[0] + \',\';' . "\r\n" . '					 for( m=0;m<theObj.options.length;m++ ) { ' . "\r\n" . '						if( theOptionTextValueListStr.indexOf(","+  theObj.options[m].value + ",") != -1 )' . "\r\n" . '						{' . "\r\n" . '						    isTheOriList = true;' . "\r\n" . '							break;' . "\r\n" . '						}' . "\r\n" . '					 }' . "\r\n" . '					 if( isTheOriList == false )' . "\r\n" . '					 {' . "\r\n" . '						 //文本数组' . "\r\n" . '						 theOptionText = theOptionTextValueArray[1].split(\'####\');' . "\r\n" . '						 //清空所有的Options' . "\r\n" . '						 theObj.options.length=0;' . "\r\n" . '						 theObj.options.add(new Option(\'请选择...\',\'\')); ' . "\r\n" . '						 for(j=0;j<=theOptinValue.length-1;j++){' . "\r\n" . '							theObj.options.add(new Option(theOptionText[j],theOptinValue[j])); ' . "\r\n" . '						 }' . "\r\n" . '					 }' . "\r\n" . '			    } //end for if' . "\r\n" . '			}//end for if islist' . "\r\n" . '	    } //end for for' . "\r\n" . '' . "\r\n" . '		//判断选中' . "\r\n" . '		if( theOriValue != \'\' && isTheOriList == false )' . "\r\n" . '		{' . "\r\n" . '		    theItemOptionIDList = \',\' + theOriValue + \',\' ;' . "\r\n" . '		    for( i=0;i<theObj.options.length;i++ )' . "\r\n" . '			{' . "\r\n" . '				if( theItemOptionIDList.indexOf(","+ theObj.options[i].value + ",") == -1 )' . "\r\n" . '				{' . "\r\n" . '					theObj.options[i].selected = false;' . "\r\n" . '				}' . "\r\n" . '				else' . "\r\n" . '				{' . "\r\n" . '' . "\r\n" . '					theObj.options[i].selected = true;' . "\r\n" . '				}' . "\r\n" . '			}' . "\r\n" . '		}		   ' . "\r\n" . '    }//end for if' . "\r\n" . '}' . "\r\n" . '' . "\r\n" . ' function getCondOptionNoSamePage(theBaseValue,theID,theOriValue,theOptionList){' . "\r\n" . '  ' . "\r\n" . '   var theObj =  eval("document.getElementById(\\"option_"+theID + "\\")");' . "\r\n" . '   var theBaseOptionIDArray,theOptionGroup,theOptionTextValueArray,theOptinValue,theOptionText;' . "\r\n" . '   var theItemOptionIDList;' . "\r\n" . '   var isTheOriList = false;' . "\r\n" . '' . "\r\n" . '   if( theBaseValue != \'\' )' . "\r\n" . '	{' . "\r\n" . '		theBaseOptionIDArray = theOptionList.split(\'****\');' . "\r\n" . '		for(k=0;k<=theBaseOptionIDArray.length-1;k++)' . "\r\n" . '		{' . "\r\n" . '			theOptionGroup = theBaseOptionIDArray[k].split(\'||||\');' . "\r\n" . '            if( theBaseValue == theOptionGroup[0] ) {' . "\r\n" . '				     //值与文本联合字符串数组' . "\r\n" . '					 theOptionTextValueArray = theOptionGroup[1].split(\'&&&&\');' . "\r\n" . '					 //值数组' . "\r\n" . '					 theOptinValue = theOptionTextValueArray[0].split(\',\');' . "\r\n" . '					 //查原有ID是否在数组中' . "\r\n" . '					 theOptionTextValueListStr = \',\' + theOptionTextValueArray[0] + \',\';' . "\r\n" . '					 for( m=0;m<theObj.options.length;m++ ) { ' . "\r\n" . '						if( theOptionTextValueListStr.indexOf(","+  theObj.options[m].value + ",") != -1 )' . "\r\n" . '						{' . "\r\n" . '						    isTheOriList = true;' . "\r\n" . '							break;' . "\r\n" . '						}' . "\r\n" . '					 }' . "\r\n" . '					 if( isTheOriList == false )' . "\r\n" . '					 {' . "\r\n" . '						 //文本数组' . "\r\n" . '						 theOptionText = theOptionTextValueArray[1].split(\'####\');' . "\r\n" . '						 //清空所有的Options' . "\r\n" . '						 theObj.options.length=0;' . "\r\n" . '						 theObj.options.add(new Option(\'请选择...\',\'\')); ' . "\r\n" . '						 for(j=0;j<=theOptinValue.length-1;j++){' . "\r\n" . '							theObj.options.add(new Option(theOptionText[j],theOptinValue[j])); ' . "\r\n" . '						 }' . "\r\n" . '					 }' . "\r\n" . '			}//end for if islist' . "\r\n" . '	    } //end for for' . "\r\n" . '' . "\r\n" . '		//判断选中' . "\r\n" . '		if( theOriValue != \'\' && isTheOriList == false )' . "\r\n" . '		{' . "\r\n" . '		    theItemOptionIDList = \',\' + theOriValue + \',\' ;' . "\r\n" . '		    for( i=0;i<theObj.options.length;i++ )' . "\r\n" . '			{' . "\r\n" . '				if( theItemOptionIDList.indexOf(","+ theObj.options[i].value + ",") == -1 )' . "\r\n" . '				{' . "\r\n" . '					theObj.options[i].selected = false;' . "\r\n" . '				}' . "\r\n" . '				else' . "\r\n" . '				{' . "\r\n" . '' . "\r\n" . '					theObj.options[i].selected = true;' . "\r\n" . '				}' . "\r\n" . '			}' . "\r\n" . '		}		   ' . "\r\n" . '    }//end for if' . "\r\n" . '}';

?>
