<?php
//dezend by http://www.yunlu99.com/
echo 'function create_weight_qtn(questionID)' . "\r\n" . '{' . "\r\n" . '	var theInfoQtnName = qNoScriptString(QtnListArray[questionID].questionName);' . "\r\n" . '' . "\r\n" . '	var questionRequire = \'\';' . "\r\n" . '	var questionName = \'\';' . "\r\n" . '	var questionNotes = \'\';' . "\r\n" . '	if( QtnListArray[questionID].isRequired == 1 )' . "\r\n" . '	{' . "\r\n" . '		questionRequire = \'<span class=red>*</span>\';' . "\r\n" . '	}' . "\r\n" . '	questionName = qQuotaChar(qJsonCharFilter(QtnListArray[questionID].questionName));' . "\r\n" . '	questionNotes = \'[比重题]\';' . "\r\n" . '' . "\r\n" . '	var dataqtn = "{ ";' . "\r\n" . '    dataqtn += " questionID: "+questionID+",";' . "\r\n" . '    dataqtn += " questionRequire: \'"+questionRequire+"\',";' . "\r\n" . '    dataqtn += " questionName: \'"+qShowQtnName(questionName,questionID,1)+"\',";' . "\r\n" . '    dataqtn += " questionNotes: \'"+questionNotes+"\',";' . "\r\n" . '    questionTips = qQuotaChar(qJsonCharFilter(QtnListArray[questionID].questionNotes));' . "\r\n" . '    dataqtn += " questionTips: \'"+qShowQtnName(questionTips,questionID,2)+"\',";' . "\r\n" . '' . "\r\n" . '	var check_survey_form_no_con_list = \'\';' . "\r\n" . '	if( QtnListArray[questionID].isSelect == 2)  //来自前述数值填空题' . "\r\n" . '	{' . "\r\n" . '		//来源问题不存在' . "\r\n" . '		var theBaseID = QtnListArray[questionID].baseID;' . "\r\n" . '		theBaseQtnArray = QtnListArray[theBaseID];' . "\r\n" . '		if( count(theBaseQtnArray) ==0 && QtnListArray[questionID].isRequired == 1)' . "\r\n" . '		{' . "\r\n" . '			check_survey_form_no_con_list += "\\tshowMessage(\'"+theInfoQtnName+"，来源问题不存在或已被删除\');return false;\\n";' . "\r\n" . '		}' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	if( QtnListArray[questionID].isSelect == 2)  //来自前述数值填空题' . "\r\n" . '	{' . "\r\n" . '		if( ! IsSamePage(questionID,QtnListArray[questionID].baseID) )  //不在同页' . "\r\n" . '		{' . "\r\n" . '			if( count(dataRow.rows) != 0 )' . "\r\n" . '			{' . "\r\n" . '				if( dataRow.rows[0][dataIndex[\'option_\'+QtnListArray[questionID].baseID]] != \'\' && dataRow.rows[0][dataIndex[\'option_\'+QtnListArray[questionID].baseID]] != \'0\')' . "\r\n" . '				{' . "\r\n" . '					maxSizeValue = dataRow.rows[0][dataIndex[\'option_\'+QtnListArray[questionID].baseID]];' . "\r\n" . '				}' . "\r\n" . '				else' . "\r\n" . '				{' . "\r\n" . '					maxSizeValue = 0;' . "\r\n" . '				}' . "\r\n" . '			}' . "\r\n" . '			else' . "\r\n" . '			{' . "\r\n" . '				maxSizeValue = 0;' . "\r\n" . '			}' . "\r\n" . '		}' . "\r\n" . '		else' . "\r\n" . '		{' . "\r\n" . '			maxSizeValue  = "document.Survey_Form.option_"+QtnListArray[questionID].baseID+".value";' . "\r\n" . '		}' . "\r\n" . '	}' . "\r\n" . '	else  ' . "\r\n" . '	{' . "\r\n" . '		maxSizeValue = QtnListArray[questionID].maxSize;' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '    //显示评估项目' . "\r\n" . '	var remove_value_list = \'\';' . "\r\n" . '	var isHaveSessionValue = false;' . "\r\n" . '	var theRankListArray = [];' . "\r\n" . '	var t=0;' . "\r\n" . '	var optionTotalNum = count(RankListArray[questionID]);' . "\r\n" . '	if( QtnListArray[questionID].isRandOptions == 1 ) //随机' . "\r\n" . '	{' . "\r\n" . '		 if( QtnListArray[questionID].isHaveOther != 1 )' . "\r\n" . '		 {' . "\r\n" . '			 var tmpArray = [];' . "\r\n" . '			 for(var tmp in RankListArray[questionID] )' . "\r\n" . '			 {' . "\r\n" . '				 tmpArray.push(tmp);' . "\r\n" . '				 if( t == 0 )' . "\r\n" . '				 {' . "\r\n" . '					var minOptionNum = tmp;' . "\r\n" . '				 }' . "\r\n" . '				 if( t == optionTotalNum-1 )' . "\r\n" . '				 {' . "\r\n" . '					var maxOptionNum = tmp;' . "\r\n" . '				 }' . "\r\n" . '				 t++;' . "\r\n" . '			 }' . "\r\n" . '			 var theRandListArray = array_rand(tmpArray,optionTotalNum);' . "\r\n" . '			 for( var i=0;i<theRandListArray.length;i++)' . "\r\n" . '			 {' . "\r\n" . '				 theRankListArray.push(tmpArray[theRandListArray[i]]);' . "\r\n" . '			 }' . "\r\n" . '			 tmpArray = null;' . "\r\n" . '			 theRandListArray = null;' . "\r\n" . '		}' . "\r\n" . '		else' . "\r\n" . '		{' . "\r\n" . '			 var tmpArray = [],t1=0,theExOptionID=0;' . "\r\n" . '			 for(var tmp in RankListArray[questionID] )' . "\r\n" . '			 {' . "\r\n" . '				 if( t1 != optionTotalNum-1 )' . "\r\n" . '				 {' . "\r\n" . '					tmpArray.push(tmp);' . "\r\n" . '					if( t1 == 0 )' . "\r\n" . '					{' . "\r\n" . '						var minOptionNum = tmp;' . "\r\n" . '					}' . "\r\n" . '				 }' . "\r\n" . '				 else' . "\r\n" . '				 {' . "\r\n" . '					theExOptionID = tmp;' . "\r\n" . '					var maxOptionNum = tmp;' . "\r\n" . '				 }' . "\r\n" . '				 t1++;' . "\r\n" . '			 }' . "\r\n" . '			 var theRandListArray = array_rand(tmpArray,optionTotalNum-1);' . "\r\n" . '			 for( var i=0;i<theRandListArray.length;i++)' . "\r\n" . '			 {' . "\r\n" . '				 theRankListArray.push(tmpArray[theRandListArray[i]]);' . "\r\n" . '			 }' . "\r\n" . '			 //互斥项' . "\r\n" . '			 theRankListArray.push(theExOptionID);' . "\r\n" . '			 tmpArray = null;' . "\r\n" . '			 theRandListArray = null;' . "\r\n" . '		}' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		 for( var tmp in RankListArray[questionID] )' . "\r\n" . '		 {' . "\r\n" . '			theRankListArray.push(tmp);' . "\r\n" . '			if( t == 0 )' . "\r\n" . '			{' . "\r\n" . '				var minOptionNum = tmp;' . "\r\n" . '			}' . "\r\n" . '			if( t == optionTotalNum-1 )' . "\r\n" . '			{' . "\r\n" . '				var maxOptionNum = tmp;' . "\r\n" . '			}' . "\r\n" . '			t++;' . "\r\n" . '		 }' . "\r\n" . '	}' . "\r\n" . '    dataqtn += " qtns:[ ";' . "\r\n" . '	var tmp = 0;' . "\r\n" . '	var lastOptionId = optionTotalNum -1;' . "\r\n" . '	for( var k in theRankListArray )' . "\r\n" . '	{' . "\r\n" . '		var question_rankID = theRankListArray[k];' . "\r\n" . '		var theQuestionArray = RankListArray[questionID][question_rankID];' . "\r\n" . '' . "\r\n" . '		dataqtn += "{";' . "\r\n" . '		if( QtnListArray[questionID].isHaveOther != 1 )' . "\r\n" . '		{' . "\r\n" . '			dataqtn += "optionName:\'"+qJsonCharFilter(theQuestionArray.optionName)+"\',";' . "\r\n" . '		}' . "\r\n" . '		else' . "\r\n" . '		{' . "\r\n" . '			if( tmp != lastOptionId )' . "\r\n" . '			{' . "\r\n" . '				dataqtn += "optionName:\'"+qJsonCharFilter(theQuestionArray.optionName)+"\',";' . "\r\n" . '			}' . "\r\n" . '			else' . "\r\n" . '			{' . "\r\n" . '				var optionName = qJsonCharFilter(theQuestionArray.optionName)+"</span>&nbsp;&nbsp;<span style=\\"vertical-align:middle\\"><input type=text name=\\"TextOtherValue_"+questionID+"\\" id=\\"TextOtherValue_"+questionID+"\\" size=15 value=\\"";' . "\r\n" . '				if( count(dataRow.rows) != 0 )' . "\r\n" . '				{' . "\r\n" . '					optionName += qhtmlspecialchars(dataRow.rows[0][dataIndex[\'TextOtherValue_\'+questionID]]);' . "\r\n" . '				}' . "\r\n" . '				else' . "\r\n" . '				{' . "\r\n" . '					optionName += "";' . "\r\n" . '				}' . "\r\n" . '				optionName += "\\"></span>";' . "\r\n" . '				dataqtn += "optionName:\'"+optionName+"\',";' . "\r\n" . '			}' . "\r\n" . '		}' . "\r\n" . '		dataqtn += " optionID: \'option_"+questionID+\'_\'+question_rankID+"\',";' . "\r\n" . '		dataqtn += " optionNameID: \'"+question_rankID+"\',";		' . "\r\n" . '		dataqtn += " maxSize: \'"+maxSizeValue+"\',";' . "\r\n" . '		dataqtn += " minOptionNum: \'"+minOptionNum+"\',";' . "\r\n" . '		dataqtn += " maxOptionNum: \'"+maxOptionNum+"\',";' . "\r\n" . '		if( count(dataRow.rows) != 0 )' . "\r\n" . '		{' . "\r\n" . '			if( dataRow.rows[0][dataIndex[\'option_\'+questionID+\'_\'+question_rankID]] != \'\' && dataRow.rows[0][dataIndex[\'option_\'+questionID+\'_\'+question_rankID]] != \'0\' && dataRow.rows[0][dataIndex[\'option_\'+questionID+\'_\'+question_rankID]] != \'0.00\' )' . "\r\n" . '			{' . "\r\n" . '				dataqtn += " value:\'"+dataRow.rows[0][dataIndex[\'option_\'+questionID+\'_\'+question_rankID]]+"\'";' . "\r\n" . '			}' . "\r\n" . '			else' . "\r\n" . '			{' . "\r\n" . '				dataqtn += " value:\'\'";' . "\r\n" . '			}' . "\r\n" . '		}' . "\r\n" . '		else' . "\r\n" . '		{' . "\r\n" . '			dataqtn += " value:\'\'";' . "\r\n" . '		}' . "\r\n" . '		dataqtn += "},";' . "\r\n" . '' . "\r\n" . '		//记录移除值' . "\r\n" . '		remove_value_list +="\\tTextUnInput(document.Survey_Form.option_"+questionID+\'_\'+question_rankID+");\\n";' . "\r\n" . '		//处理页面字段' . "\r\n" . '		this_fields_list += \'option_\'+questionID+\'_\'+question_rankID+\'|\';' . "\r\n" . '		this_fields_type += \'3|\';' . "\r\n" . '		' . "\r\n" . '		//页面检查' . "\r\n" . '		var maxValue = maxSizeValue;' . "\r\n" . '		check_survey_form_no_con_list += "\\tif (!CheckIsValue(document.Survey_Form."+\'option_\'+questionID+\'_\'+question_rankID+", \'"+theInfoQtnName+\' - \'+qNoScriptString(theQuestionArray.optionName)+"\',0,"+maxValue+")){return false;} \\n";' . "\r\n" . '		if( QtnListArray[questionID].isHaveOther == 1 && tmp == lastOptionId )' . "\r\n" . '		{' . "\r\n" . '			check_survey_form_no_con_list += "\\tif (Trim(document.Survey_Form.TextOtherValue_"+questionID+".value) != \'\' )\\n\\t{\\n\\t\\tif (!CheckNotNull(document.Survey_Form.option_"+questionID+\'_\'+question_rankID+", \'"+theInfoQtnName+\' - \'+qNoScriptString(theQuestionArray.optionName)+"\')){return false;} \\n\\t}\\n";' . "\r\n" . '			check_survey_form_no_con_list += "\\tif (Trim(document.Survey_Form.option_"+questionID+"_"+question_rankID+".value) != \'\' )\\n\\t{\\n\\t\\tif (!CheckNotNull(document.Survey_Form.TextOtherValue_"+questionID+",\'"+theInfoQtnName+\' - \'+qNoScriptString(theQuestionArray.optionName)+"\')){return false;}\\n";' . "\r\n" . '			check_survey_form_no_con_list += "\\t}\\n";' . "\r\n" . '			check_survey_form_no_con_list += "\\telse\\n\\t{\\n\\t\\tTextUnInput(document.Survey_Form.TextOtherValue_"+questionID+");\\n\\t}\\n";' . "\r\n" . '		}' . "\r\n" . '		//矩阵行关联' . "\r\n" . '		var QtnAssCon = _GetQtnAssCond(questionID,question_rankID);' . "\r\n" . '		if( QtnAssCon != \'\' )' . "\r\n" . '		{' . "\r\n" . '			check_survey_conditions_list += "\\tif("+QtnAssCon+")\\n\\t{\\n";' . "\r\n" . '			check_survey_conditions_list += "\\t\\t$(\\"#range_weight_"+question_rankID+"_container\\").hide();\\n";			' . "\r\n" . '			check_survey_conditions_list += "\\t\\tTextUnInput(document.Survey_Form.option_"+questionID+\'_\'+question_rankID+");\\n";' . "\r\n" . '			if( QtnListArray[questionID].isHaveOther == 1 && tmp == lastOptionId )' . "\r\n" . '			{' . "\r\n" . '				check_survey_conditions_list += "\\t\\tTextUnInput(document.Survey_Form.TextOtherValue_"+questionID+");\\n";' . "\r\n" . '			}' . "\r\n" . '			check_survey_conditions_list += "\\t} \\n";' . "\r\n" . '			check_survey_conditions_list += "\\telse { \\n";' . "\r\n" . '			check_survey_conditions_list += "\\t\\t$(\\"#range_weight_"+question_rankID+"_container\\").show();\\n\\t} \\n";' . "\r\n" . '		}' . "\r\n" . '		tmp++' . "\r\n" . '	}' . "\r\n" . '	dataqtn = dataqtn.substr(0,dataqtn.length-1)+"] }";' . "\r\n" . '	' . "\r\n" . '	if( QtnListArray[questionID].isHaveOther == 1 )' . "\r\n" . '	{' . "\r\n" . '		this_fields_list += \'TextOtherValue_\'+questionID+\'|\';' . "\r\n" . '		this_fields_type += \'3|\';' . "\r\n" . '		remove_value_list +="\\tTextUnInput(document.Survey_Form.TextOtherValue_"+questionID+");\\n";' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	check_survey_conditions_list += "\\tReCalcSum("+questionID+","+minOptionNum+","+maxOptionNum+","+maxSizeValue+"); \\n";' . "\r\n" . '' . "\r\n" . '	//页面检查' . "\r\n" . '	if( QtnListArray[questionID].isRequired == 1 )' . "\r\n" . '	{' . "\r\n" . '		check_survey_form_no_con_list += "\\tif (document.Survey_Form.option_"+questionID+"_total.value != 0 ){\\n";' . "\r\n" . '		check_survey_form_no_con_list += "\\t\\tshowMessage(\'"+theInfoQtnName+",尚有未分配的比重值\');\\n";' . "\r\n" . '		check_survey_form_no_con_list += "\\t\\treturn false;\\n\\t}\\n";' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		check_survey_form_no_con_list += "\\tvar objValue = document.Survey_Form.option_"+questionID+"_total.value;\\n";' . "\r\n" . '		check_survey_form_no_con_list += "\\tif (objValue != "+QtnListArray[questionID].maxSize+" && objValue < 0){\\n";' . "\r\n" . '		check_survey_form_no_con_list += "\\t\\tshowMessage(\'"+theInfoQtnName+",尚有未分配的比重值\');\\n";' . "\r\n" . '		check_survey_form_no_con_list += "\\t\\treturn false;\\n\\t}\\n";' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	//逻辑条件' . "\r\n" . '	QuestionCon = _GetQuestionCond(questionID,qid);' . "\r\n" . '	if( QuestionCon != \'\' )' . "\r\n" . '	{' . "\r\n" . '		check_survey_conditions_list += "\\tif("+QuestionCon+")\\n\\t{\\n";' . "\r\n" . '		check_survey_conditions_list += "\\t\\t$(\'#question_"+questionID+"\').show();\\n\\t} \\n";' . "\r\n" . '		check_survey_conditions_list += "\\telse { \\n";' . "\r\n" . '		check_survey_conditions_list += "\\t\\t$(\'#question_"+questionID+"\').hide();\\n\\t} \\n";' . "\r\n" . '' . "\r\n" . '		var check_form_list = "\\tif("+QuestionCon+")\\n\\t{\\n";' . "\r\n" . '		check_form_list += check_survey_form_no_con_list;' . "\r\n" . '		check_form_list += "\\t}\\n";' . "\r\n" . '		//移除已回复的值' . "\r\n" . '		check_form_list += "\\telse{\\n";' . "\r\n" . '		check_form_list += remove_value_list;' . "\r\n" . '		check_form_list += "\\t}\\n";' . "\r\n" . '		' . "\r\n" . '		check_survey_form_list += check_form_list;' . "\r\n" . '	}' . "\r\n" . '	else' . "\r\n" . '	{' . "\r\n" . '		check_survey_form_list += check_survey_form_no_con_list;' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	//关联关系' . "\r\n" . '	var RelSurveyCon = _GetSurveyValueRelationCond(questionID,qid,\'cn\');' . "\r\n" . '	if( RelSurveyCon != \'\' )' . "\r\n" . '	{' . "\r\n" . '		//此题存在多个数值关联关系的检查点' . "\r\n" . '		var theRelSurveyCon = RelSurveyCon.split(\'$$$$$$\');' . "\r\n" . '		for( var t in theRelSurveyCon )' . "\r\n" . '		{' . "\r\n" . '			var tRelSurveyCon = theRelSurveyCon[t].split(\'######\');' . "\r\n" . '			if( parseInt(tRelSurveyCon[0]) == 2 ) //空题' . "\r\n" . '			{' . "\r\n" . '				survey_empty_list += tRelSurveyCon[1];' . "\r\n" . '				var theEmptyList = tRelSurveyCon[1].split(\'*\');' . "\r\n" . '				var theEmptyId = parseInt(substr(theEmptyList[7],0,-3));' . "\r\n" . '				if( !IsSamePage(theEmptyId,questionID)) //不在同页' . "\r\n" . '				{' . "\r\n" . '					//空题字段' . "\r\n" . '					this_fields_list += \'option_\'+theEmptyId+\'|\';' . "\r\n" . '					this_fields_type += \'3|\';' . "\r\n" . '					//跑一遍空题的配额表达式' . "\r\n" . '					var theEmptyEndSurveyCon = _GetSurveyQuotaCond(theEmptyId,qid,\'cn\');' . "\r\n" . '					if( theEmptyEndSurveyCon != \'\' )' . "\r\n" . '					{' . "\r\n" . '						survey_quota_list += theEmptyEndSurveyCon;' . "\r\n" . '					}' . "\r\n" . '				}' . "\r\n" . '				theEmptyList = null;' . "\r\n" . '			}' . "\r\n" . '			else' . "\r\n" . '			{' . "\r\n" . '				survey_quota_list += tRelSurveyCon[1];' . "\r\n" . '			}' . "\r\n" . '			tRelSurveyCon = null;' . "\r\n" . '		}' . "\r\n" . '		theRelSurveyCon = null;' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	//问卷结束条件' . "\r\n" . '	var EndSurveyCon = _GetSurveyQuotaCond(questionID,qid,\'cn\');' . "\r\n" . '	if( EndSurveyCon != \'\' )' . "\r\n" . '	{' . "\r\n" . '		survey_quota_list += EndSurveyCon;' . "\r\n" . '	}' . "\r\n" . '' . "\r\n" . '	//改变背景颜色' . "\r\n" . '	check_survey_conditions_list += "\\tchangeMaskingSingleBgColor("+questionID+");\\n";' . "\r\n" . '' . "\r\n" . '	var tplText = \'<table width="100%" class="pertable" id="question_{$questionID}"><tr><td class="question" valign=center>&nbsp;{$questionRequire}<span class="textEdit" id="questionName_{$questionID}">{$questionName}</span>&nbsp;<span class=notes>{$questionNotes}</span></td></tr><tr><td class="tips"><span class="textEdit" id="questionNotes_{$questionID}">{$questionTips}</span></td></tr><tr><td><table cellSpacing=0 cellPadding=0 width=100% id="qtn_table_{$questionID}">{foreach $qtns as $i => $qtn}<tr class=tdheight id="range_weight_{$qtn.optionNameID}_container"><td class="answer" align=right nowrap valign=center>&nbsp;&nbsp;<span class="textEdit" id="optionName_16_{$questionID}_{$qtn.optionNameID}">{$qtn.optionName}</span></td><td width=8></td><td class="answer" align="center" nowrap><input type="number" size=8 name="{$qtn.optionID}" id="{$qtn.optionID}" maxlength="8" onKeyUp="this.value=this.value.replace(/[^\\\\d\\\\.\\\\d]/g,\\\'\\\')" onafterpaste="this.value=this.value.replace(/[^\\\\d\\\\.\\\\d]/g,\\\'\\\')" onblur="ReCalcSum({$questionID},{$qtn.minOptionNum},{$qtn.maxOptionNum},{$qtn.maxSize});jQuery.Check_Survey_Conditions();" value="{$qtn.value}"></td><td width=*></td></tr>{/foreach}<tr class="no_color_tr"><td align=right class="answer" nowrap>剩余可分配：</td><td width=8></td><td class="answer" align="center" nowrap><input type="text" size=8 name="option_{$questionID}_total" id="option_{$questionID}_total" disabled></td><td width=90%></td></tr></table></td></tr></table>\';' . "\r\n" . '' . "\r\n" . '	var jsondata = eval(\'(\'+dataqtn+\')\');' . "\r\n" . '	var t = new jSmart(tplText);	' . "\r\n" . '	//$(\'#survey_content_container\').append( t.fetch(jsondata)); ' . "\r\n" . '	survey_content_container_html += t.fetch(jsondata);' . "\r\n" . '	jsondata = null;' . "\r\n" . '	theQuestionArray = null;' . "\r\n" . '	theRankListArray = null;' . "\r\n" . '}';

?>
